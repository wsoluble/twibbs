version: "3.8"

services:

  db:
    container_name: 'db'
    build:
      context: ./project/db
      dockerfile: Dockerfile
    restart: always
    hostname: ${MYSQL_HOST_NAME}
    networks:
      dapp_ns:
        ipv4_address: 172.16.238.3
    environment:
      MYSQL_ROOT_HOST: '%'
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_HOST_NAME: ${MYSQL_HOST_NAME}
    volumes:
      - type: bind
        source: ./project/db/initdb
        target: /docker-entrypoint-initdb.d
        volume:
          nocopy: true
      - type: bind
        source: ./project/db/conf/my.cnf
        target: /etc/mysql/conf.d/my.cnf
        volume:
          nocopy: true
      - type: bind
        source: ./logs/db
        target: /var/log/mysql
        volume:
          nocopy: true
      - type: bind
        source: ./logs/initdb
        target: /var/log/initdb
        volume:
          nocopy: true
      #- type: bind
      #  source: ./project/db/data
      #  target: /var/lib/mysql

  web:
    container_name: 'web'
    build:
      context: ./project/web
      dockerfile: Dockerfile
    restart: always
    hostname: web-server
    networks:
      dapp_ns:
        ipv4_address: ${WEB_HOST_ADDR}
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_HOST_NAME: ${MYSQL_HOST_NAME}
      WEB_HOST_ADDR: ${WEB_HOST_ADDR}
    ports:
      - 9080:80
    volumes:
      - type: bind
        source: ./project/web/public
        target: /var/www/public
        volume:
          nocopy: true
      - type: bind
        source: ./project/web/app
        target: /var/www/app
        volume:
          nocopy: true
      - type: bind
        source: ./logs/web
        target: /var/log/apache2
        volume:
          nocopy: true
    depends_on:
      - db

  phpmyadmin:
    container_name: 'phpmyadmin'
    image: 'phpmyadmin:5.1.0'
    restart: always
    networks:
      dapp_ns:
        ipv4_address: 172.16.238.5
    ports:
      - 9081:80
    environment:
      - PMA_HOSTS=${MYSQL_HOST_NAME}
      - PMA_ARBITRARY=-1
    depends_on:
      - web

networks:
  dapp_ns:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.16.238.0/24
          gateway: 172.16.238.1
